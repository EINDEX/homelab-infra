version: '3'

services:
  

  wiki:
    # image: yegle/wiki
    image: ghcr.io/requarks/wiki:2
    environment:
      - TZ=Asia/Shanghai
      - DB_TYPE=postgres
      - DB_HOST=wiki-db
      - DB_PORT=5432
      - DB_USER=${WIKI_PG_DB:-wiki}
      - DB_PASS=${WIKI_PG_PASS:?database password required}
      - DB_NAME=${WIKI_PG_DB:-wiki}
    networks:
      - wiki
      - default
    depends_on:
      - wiki-db
    labels:
      com.centurylinklabs.watchtower.enable: true
      traefik.enable: true
      traefik.docker.network: network_default
      traefik.http.routers.wiki.tls: true
      traefik.http.routers.wiki.tls.certresolver: ${ACME_NAME}
      traefik.http.routers.wiki.entrypoints: websecure
      traefik.http.routers.wiki.tls.domains[0].main: ${TF_VAR_domain}
      traefik.http.routers.wiki.tls.domains[0].sans: "*.${TF_VAR_domain}"
      traefik.http.routers.wiki.rule: Host(`wiki.${TF_VAR_domain}`)
      traefik.http.routers.wiki.middlewares: authentik-docker@file
      traefik.http.services.wiki.loadbalancer.server.port: 3000
      traefik.http.services.wiki.loadbalancer.passhostheader: true
    restart: unless-stopped

  wiki-db:
    image: docker.io/library/postgres:15-alpine
    user: ${DOCKER_UID}:${DOCKER_GID}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      start_period: 20s
      interval: 30s
      retries: 5
      timeout: 5s
    networks:
      - wiki
    volumes:
      - ${CONFIG_PATH}/wiki/database:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=${WIKI_PG_PASS:?database password required}
      - POSTGRES_USER=${WIKI_PG_USER:-wiki}
      - POSTGRES_DB=${WIKI_PG_DB:-wiki}
      - PUID=1026
      - PGID=100
      - TZ=Asia/Shanghai
networks:
  default:
    name: network_default
    external: true
  wiki:
